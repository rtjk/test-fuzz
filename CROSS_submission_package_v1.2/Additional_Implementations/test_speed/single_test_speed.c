#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include <time.h>

#include "api.h"
#include "csprng_hash.h"

#define NUM_TESTS 1000000 //100000
#define PROGRESS 300
#define PRINTARRAY 1000001

void parse_hex_string(const char *hex_str, unsigned char *array, size_t len) {
    for (size_t i = 0; i < len; i++) {
        sscanf(hex_str + 2 * i, "%2hhx", &array[i]);
    }
}

void simple_randombytes(unsigned char *x, unsigned long long xlen) {
    for (unsigned long long i = 0; i < xlen; i++) {
        x[i] = (unsigned char) (rand() % 256);
    }
}

static void print_array(const char *name, unsigned char *array, unsigned long long len) {
    printf("%s: ", name);
    for (size_t i = 0; i < len; i++) {
        if(i < 3) printf("%02x", array[i]);
        else if(i == len/2) printf(" ... ");
        else if(i > (len-4)) printf("%02x", array[i]);
    }
    printf("\n");
}

static void print_array_full(const char *name, unsigned char *array, unsigned long long len) {
    printf("%s: ", name);
    for (size_t i = 0; i < len; i++) {
        printf("%02x", array[i]);
    }
    printf("\n");
}

int main() {
    
    unsigned char       *m, *sm, *m1;
    unsigned char       *sig;
    unsigned long long  siglen;
    unsigned long long  mlen;
    unsigned long long  smlen;
    unsigned long long  mlen1;
    unsigned char       pk[CRYPTO_PUBLICKEYBYTES], sk[CRYPTO_SECRETKEYBYTES];

    unsigned char       entropy_input[48] = {0};

    mlen = 50;

    m = (unsigned char *)calloc(mlen, sizeof(unsigned char));
    m1 = (unsigned char *)calloc(mlen+CRYPTO_BYTES, sizeof(unsigned char));
    sm = (unsigned char *)calloc(mlen+CRYPTO_BYTES, sizeof(unsigned char));
    sig = (unsigned char *)calloc(CRYPTO_BYTES, sizeof(unsigned char));

    setbuf(stdout, NULL);

    // TODO: move initialization inside/outside the for loop
    simple_randombytes(entropy_input, 48);
    initialize_csprng(&platform_csprng_state, entropy_input, 48);

    /////////////////////////////////////////////
    const char *pk_str = "985ba07f81ece13ba8e5c304359b90d4db1dae77abd181236cbefd3d27ec9b19bc2af793964f5c874845419b5f7a870c6b08b96ed240";
    const char *sk_str = "44760f3b8a0b518be13c3e20f4e6cb0ec1c38a3779c7b188db7f6b065da22913";
    const char *m_str = "67c6697351ff4aec29cdbaabf2fbe3467cc254f81be8e78d765a2e63339fc99a66320db73158a35a255d051758e95ed4abb2";
    const char *sm_str = "67c6697351ff4aec29cdbaabf2fbe3467cc254f81be8e78d765a2e63339fc99a66320db73158a35a255d051758e95ed4abb2cff5b964b0b9873609dd8601b31090a33e869b9c11c5b0a76e7184f53be89a3bada4800ca5bac44572887094f79fa10c6329d00bbc5b1d4e81321f2dccb51c0c4a79fcfbdd177258fc02c178bb500433f926fb548c24d9d841ef8412cfc66fcb2bc7d46459798d4f1304ebfc792239b7b3eee0cfce3d6af71aa7b46667317e4a56d74bdae15228eebc3a00f75840f3c994a7a7a6b6cc0fe22e616e500390ab528f4773c47100e2714b0cb2ac377d2b779ce01e64f92d2e3bcf3b7a82f735485db54530fa0f4cc9fe268acc4f4aed822d7942caf8cab2cf3f3c602a3bac0948efa8820a205cb33482ba2512d494d89a2d4519f12e90c0dd34e5327fb06996c0a833b57af5218e1fd78b2f849d2982d532d6bbe84cb496e484a71baab0277478d70188f70232ae56a95fe6da854267f8b76ab10c156e55f6724a5092a8c5b9c9a32f4bf05a2171e88909f340edd3b03e25c0ab9eeacf4876fd8879477d62b7e0b774256f94518fc52b073e5143b09a5dd5fc1901cab868fc7607c0984f60311f6502340070af6438a14a34cdb90466aecb6833e6623cf3a5d3b450d605ad92b123691b9238fca93ca378734261235a7bca811b9c8502eda848c1b5efc3f0d950e96db1d0cea9e7450564aa21f1bffa489b58be3ce455e03fedf183ce0542fcf8087aec620624eafdff84e9278babfec9208402f11c9e69d5ccdb222fb9fbbae02e56fbb5e6575ad5d27c978156368d7f02474c2f61a6de855d9b363d77740194cb51013c87337f6c0b880c6229e593c56da5afacc2d074b12c556b7b84151272c47c2f8a116911a88e7ace9c89edc26506dad9ad44b28ec37f0c93067c0d8e441435ed4efddd3b7ca3819e503d15976b34b791fee1174753d111225cf7682b788d7b3cd17368f834220d2426d512c340c254b9ad80147b01002d9e701d9f68b21b4f31a7ea6aa76085483986fc8fc36b2abb3da93e817fd81ff7c24a7de2cd64eb17c6e0e9b17c6ce7af6b1086765699048f641dab9f587a5518f2da395330e1e7fe0f0f25944cef363030be8ead7808ea240744da75265606fcadbefb0598335abea4c0e9bd6a84b2d0f7ed6c8f31edbc754d4aff08cf9361b9fc3e1c5b33a77809c66e2b85da65c41100a02f14010e91c2889b46e7193bbf4b115d57c1527a11c9e945c4c63e8bb81c52241c7f94a520b77f7ac10e046d58935c55ba80a5c48013389f0ee6e72e40e87b248ccf2d0e82626bf20bbb5aa69585c5d7763644250f4b17881e8cad5afbb4ad95681f4a489d587d65aee45be1c7b832de68ae5eda8d22da30ba01efcc48b854f6b687efbeb92d7b81046ada2d2a72572406c25385502a59056a1731006eac55766e0894a0f253a4f1d7883edae9f9f769447f3ce3952850fb870c2e31e9c95b8fd6628b7eb70e2bfafaa1b0464b2ffd20568ba8448e90d73d80433e3d3d3e6e8de912b6a4eb1015aefb03b40eb37e69022409d64112df2e05bb0f2a27de7f2225995eb9427dc8edb45f13a6c4ae68a356901f085a50a3b966531590f8da996cbb65c138ab44220b6ea8c4e4ad1c28fc93244ac58bfa5bfe37f0e5429fcc8c65ab5c982cd74161ad5e3947bef1f7d265018b9a2f6bf82382e1cca5b5432acb34e5c8ee0cc2e6ec31e3e331215c7a1c6e5559b6359862a192c237dd071e9d02f7fbf3ac015667a302ab9ebb693e6c24395d395f733bc060cfe14c0a6f5c44517a32f9c28cec12163a48f7cb231695038ad93a30d51f968fe27b4757a7f1fecbf5dae7fad2a4267648af8ece36aa7f98d9f2950e199c172cee650daa1c1f83be153fc965f4c63a2c26e01a7f18af93e0c2b584317c5a96494f01b4add288ae08673b41a5540233f6bfcd8810f2b2628204adbcbe6ac9ee16982edbcd84a01851d8a5584ac739b98e86d4fa22352ef5f14c80eb74e04720b2e3e0ea3e181bfd9395d97a62cf8574a5cf7408697b6e088ce3340c401299446be5810607becfe68fcb08ca344ba2a4426f09d03ed7fee1b6f43136032cabe9b8c796ab3dfc7dca3fe29e77060dc416d0a6707a4a30cb39eac0d1d46e09ecaf66ce80a29dbed975ef83e3f8512990ea5c5d981fbc88e66e16ed6806870599dd534e23f189bd5050f7ce1ce080953b682f5b3c43e4ea10c32af8dde2515396bf1d35a37c6944664025d5141fea2b34d64719fa12a542b29545786f16c67cda4412542cc3b600551b129e9f8fedf2aa2c33366c9e04dc9b8e23d199629eb641cffc8695b29d37e745839c4090aa6373d95af09623bc79d0bfb12eb972620f3463b7af09575603462feee284d7cc5a831d99ccc9156db47bd90967d9aa4550bb55dbe2d0f9cb4618143b2c97ddb2e14ae7da0e6b153838187b62e05c168f583385247a2bddf380424113918b20ad0e2823c85b3fdf167508ecb47b0b1e1b054d21c29d7a7fcfccb21046c0cfb19a7765aa7d508c0058ad7aba75ae0dac77ef5462d224aa5a0d21daa9ad613bb74c3a5e7a83780ffcd1704668e475404451b9c04e16975a25eebd43b13d9a22c6375726099790a6d85de301675692b7c6f67f5828a1488bfae50f0111b3a6058c4fcda216bef06699591dba43fbbc0faf817fcadd315359eace6c8443ab2348de1bc433046cec4f6b5d8ab941e6fe58e46f778eb8ccae8b7e547ab762915b48a67b395fc5bd1c1fcfdc7255b31bf3922393178d717a09509e97cc6931b9e5f275c68637bf2af938e79672f765ca3f5ad115198a4a33ae6bb49faf8b155ca6ca3652309740419210200d10915a661b1b496312884de2adf69d15feebf7b3454d864102cb6887072dd70a1e9e5025709ff07e2659be045ec5ba4adf281afe6b4a8764af6a920fcb29755f9f4a6e09eeaa8dbe8b2c5eba1806268f04995655b6d3ae0d0f1b0c6a0d74a048b1ccdc5bba55d66dd0c6fa17a8da230ca3167153563aff4d79ae8e198378d74cf4cb54bceea6bfd6417618bf4463471ce830a6832a1448670d719c8451837dcac6fa838d3ea9ccf3893855d80708ee10ca49033d519481e4b40620f471ab103a9316e13cdcbbbff0bc7fbcfbda1672f885c54dcc50611ca006a13378949097b27fed3f6d5b12081d5342376b4fe90f6b1d302e540ec5e359005a515b5c85bb7b5ed60f9c13a220bac12c71fb0072427f07a1ba4b7313bea388cfaa755e7d50d705379cfb96adf905c5d45c994f0eedb0dcee8ff6461125d2e00b7fd491774b825c176c5ed1b9acf20ee93cf50eeaf6aa66dbc0cab3924248a1c3280537f35c3c07a92dbfeff526ebb05e728990134dac885e9e9c2ac8c79533b65853c0142bc22ca4efcaef96037d4e382a4793f8031567a832831f52eb4ba2dc790a653d2085e57fcac32140ab894955768bf93f8aca92424e0481ee078146a72b77851d6e56e921a69cdd1404d3f5561d1eaaf1f34aaeb313c06b681424e006a80dcffa8eafb666fccd7eaa2f5e01ac0c4ceec6a4a3788a5d970f51d4696ca4adc8fde52252f12bbe72ed38e9e5963abbe932cc070fa1ec2a71df3b4e052470a17fe162537769c945e99b2b3221d3d53ffc709b95c97477df11047e65b50bd65ed8801fa70ed1eb1d97d5ed52fe9a6ba31d0377fb206ea626ffde75a7703cc542b0ec090916418c2e68e0a78cd517656b62f22699393e769ffecc409b9490c395893374b6d4b86240171ba760a945fad50195eb741662da3663ac4b6047724a533bcb4ecee9d30e0f58943e32db1a80cc9f1c2844c7c7986c3cb38ed59521cc623756e28f4c09c890eb3e29f3c3d9e5e24446b07d2ab799d5a52086d78b0f5832e10c54e78cdfa82f3734498b0971f663ec2cd36268a4c98e3ca567ea1643890e01b6ee8ed5e639f37ffdbd67c31de6d2b75f8e6655d99f8120680f699f5e339c114c6dd52d51aa68c551581e3999c919e619635a04bf8b68b5b5298d021cc8e922e593c38dab74b5f97f64fa2ae7027931a463ab779dd0dbe830d288ce87910613f798d6c102689568ff0461461dca1d749c666b370f090189c3cdc04122508fe32b06fecdc3d52785be00b27b7931ddc44db5fce268aab268b5107c6767e8027ff9d823b9281d85a93494bfdce222cf5aa534ce876c53061f68629d9e46661ed3a2bbdd4b0eba15fd2ce781207df6bfececba27e623e0b3a0ba0ad1fa990908cd06bd46f1d6f6a819f8eb3d3fb57d5ca8e86ad46b9ab913443f81d45e9b7fa3d3ef3c7f81c763a090032c18425d7202f76615cb0b5b0ac3ddfb9c2be1dd22cfc4d967295066a9af6ad386a790edff73fb15707df1423107a6050fda91aed306d4cabf5aa5eee94f61151fb09df8028f8cfbb42d95d74e7be0ac0f3ae7ae14ac86e2b8049381ed4d3fb4a077056434019b56c98dd6be869e0b38fdfd178f7984cdd58f7e9b5c2c3a16c9a2e1744359c6846beb74adddf43c0f08188879320f3da5349c7ee6489ead8cfed58be63b314222211ca15a4025b2c3be02fcf40d8a99928408a475b6b4df8709957b164dec717ddbe9073515f66f429d74e0c9b07de175be5e3d0fb2d78e6032e4f06d4cf06fd2bbedb5c15cee3691836a690325cf7fb21d12c2eb8b9677c1beec000795b47a378bb52175060f7996d6d21f0cc299a63b188c527033b83ccb99ee962a3257d2d9412d10971bceefb77ccd975c578cee40491cca60213af8e72009cff33206a8daedec636de943d93292c99100c463bef08c4af50f714c03557d2d72d845728668fdd512bd91a808902a86d9899afa3d21d641179d08b12d1fad71d3e087c8adb77de408c93cc6f397d36eade714f0e2493653b1278bdb4b3eb1c1eea4d530b004418009a85de265cb1691653261183a2aa5b26285a8056abdb8f03d7ffe87e7cbab311a24683978e18760341d43a327317aee3e7a0748465abb0a391f8883738e3dd831981e65ba8246ae48f07548b55261bdd0e2a1a4e19c0de990e3706c6aa5e41bd7237948031aa841c98d410bf19a3f6f42390508f63116314fe9255791d0ad9434e308b2b0dd2031081a28de373557c9441498c85117bbc5e8dc000f59ebbe4d0c4ac3f17500e467d9d7f95bcd2ae847b973b9b63fe4956435dfd570d3b427dd9fa417011a036228a308a041b40812b6448cfa58f0b3cd6c9315be4f3a69705350be5c81886acc827eaf87201bee00a1ef61c602a088d4061cad3be23f60ca7b52501f327050ea704de3a4ed395b40edd1d3b2b25a8a7bcd8567661ef8e7ee1a36e582bc7fbf5c0a5636f0ea81a41fbaaa42fddb6d7609c00eb4b0bfbc546142ae696acea57cecf95451d97948e082b495b63ac6c1a6b0bcfa380c01cd58bdb46088321b6fb333d1d753f9ae200736033fb0a5a81c4beb803c1bba3e5759cd9241808498599fe000192bbe7b217e1bbff49d067d26bdc131d2c84c0878c59f9e3e5f1c6ede92828f20001fa2d80aa05f486440ccc7d456a876e3f06788aacd86a12bad30b8f63ab045547e463d61b85673ce42ed6c629a63d635078e094615b89f92e1f6282b49fb774321add2aa6dde013dcff3b494e64c645a44d01b10fadcee1b1cc0dd5be57318515e8148dd0157ed5cc9f040235c92be3cebceb32ce1ca3aa74e3df3924169caffae93d85fa0c1aa66e581f02c829f41d0856519974ac239a6ec71c1dff1ddce064699735ee7064072745bd0fcacc6381556413f4c2927f46f7db5711eb1b1481b4c849e46a2df60a4990becfc1069073dfb591c2d4b7fb33a8e5b7ab60a576d6346c2c2817aea2678a3fe0bfc4fd7449ecbbd9894f83115fab6f6a947ccd3a8046c5ac8ea62ad76dcfb6aecefe530ddcee638a32604aeb66de88d474806b00f9ffbed2f65651aa962cff46eb72e365b82479bd022932f3824730bd7f26a4adf1c25476293d2aa7f69c6e7a1160d9aa2a4ded1a140f1c43545b1befbcdef35db827e9b84cab7487ee1cfc8ac77325ac0626b1f044d1fe8afd7aed693982574eeecb875ccb1c843b2791f907649eea30bb2b2e1f63689e1adca6e3254c5c05c7f0ed40ae9d8b71d10b610704930e4e92efd9f5bc4c7b59fe67cf80d507bced7c23587e9d49a913da6325ef3c76f6f1951a31d728b5125df971096089753f68c242512e436fc1b7dcca39eaac00ee7972ecf885c2d5c0e33044cdafcae3deaef249f6b7ae98278221b61854c8708b3fe73fb8581f99c48154eb7c38be99fc22a80f78a6ab1a4f2819d66f9b6506d66c4a3ca7976c1966a02415bd1a22df47d10f6f07c6f02dfc8fb9214fc18b707942f01b7bd3353d1016587f9a28e53496ba7242773aa4f92ddf4fd618694978c7bd1cf7b985eed0a63e9a8cbd5511b98db4a4a2b930ef82e02a021d04d820e6530dd12c278fe61b9f50b14d63b09e5b779564fd8121d03ecb8e9ccd7f9d25d1bb9ed4d66e0c0f0ceb198c25692846b5ca2b67f0c64a7801b5b16a96c5822056096b21c0c3d4338040fc3238217ad45da3e679c562fe7413c593e79428dc8629f70e1d3d6cb9f51891637b9f37d3bc0fd02cdea636eb04c2ce7674d7c68859393f53561122e8b296e290a40502853d74dacf753e79e94869184ac0a1867b30980593f08e6d73428e26b3b5f20ece36dc6ceab031184903c259dd03de1265906b1c227d237640ca3bb19de5b2a9edf2467cd0cf28a49bd4ce4f62251a66d2f1bc1168bfa34b1dc3fb8fd4b0257721230a340dcdf6287254c421f94b9c0968e43fa339fef716d7705f904948d69bf04d7a023d4b5a8eb8c570720849c2351298be3c980c8dab011e619c867bfb8913345134a90915413fb2b44951e66f368150bfb89d120fc77406b899b9e7990fef583429134cbf2a23995b14dabe85ed0a11c3b110b53beca679e3b15df8c42c8ef927dae25c5396da23439b289b62888169d7b4c5bdc4baf05c3b8db341ee880ebe05284d2e595006e321a631a7fd8998d2d2f4a679e6a374a4997938676edc3dcc86f85c10089353279227dfc429f29743babaaa9b0f8dc0f8e0f44e6acda9a0f3553f243f8f07ec8f07fa5bbf4a7a36e351f3e3359bc145e14b94ba28fa5c5a15f613f7ab54daac14369122eb634e1c8c17c8685fc5c7e733cee62c4514d3b7900d22d00b83f8d4cfbd9a2a3d876df6e9a3853374839d90b280a64d5fbe1e5afbe3290efeaf007e3475b21ba462aa9326840703fe01aff674948e6aa4639bc5aa3e28673b0e1ff77b57ba4cfd5d354f12a2f4ff42c26976e33e3cc8d67bdf186078df2e44f84873f86fb2adc5e51b79904c63107671cf23d7ca08c822da3234a69dec3fc66ec1c3aa3c1c4a8a7484f5560a1d0fa7439207788ac8bbc7be8e2a1a83cfe6089c0f11dbbc457dcc86959fec20daa5f48be6f60c919f660ce68d0b4144174f1697e447ee99ee88b1c5b80320b3a5b38def723f165981d118a894eeb0eb3d73932aa4dea0323a58a9d99ad6400f9417362540bfce184d005256d331f551ec8712287caa90658b608752105a726999e76a1a5a1293f2b6c1d750eed43e1f134700cd306af09c7c62d0df66b7547ae1395c1dff50cb63f7dd249ce540b835b1042bfd5fbf663dfc1439cab173f7b2ef29e4a0918ed31e0e4322483272a265db31cc9bf2acaeb59b5a9760f5baaf1a9300568b99d81a2b57029716c5b744d6ade9be029dba1f21d7c592fefc65e0801c3a2a09ab7bbcaec9e68726ea39161c9875ca3991f77e29aaad77659c58da201003e0c43184e20c5091c82d2c134fd9f85bce206825abc00000000000000000000000000000000000000000000000000000000000000000cf1de08f4f7bf4a098589d85026bdc04b878a341911576c4c88c07ca21a2ad4894197638a5ea0a8e87bdcb97ec462c271a20a1eb602a38c4b48c23d4e92c31381f2f5d9d99df6055054543fe7db01b7c7af398874be374ecd5675018bdc6fda51661a4d7f117cfc8e071e60ea1895b25c82d0f1c18536b895cc70f1996961e10efb6033fd919abc79d3ec575488549ef3745893ab851789f63a5578fbf05c1b5454a715f9d6b79e11b13853f6df25c1dd224ba487361d6f6708d4e108881b29b051d9835e6ad4b4340de6da61b0706e104596865958bc6657f09af6b01e07c79579dad9fed88ee70226f81340215f22881e99e43a8845b5f9a7c5340283bdf42ee687e7cd98f9f42845160c10ccf820ce417c4675da008c4b9e282dd85108980f7abaa1cec907dd2bc0bf01071aaf6dc914de5a6bf59fa0ec9856cf3fb31d81f847c22b5e1346ad2f04c14d09c2e822e25259e3768894f7effcabae58ed75cea568e6875753afde5aa8ce72aa4a00bce15ac27cc2a90cdde97b32f23745174371bfb018644ceafa1572e7bad014bfece413a89ce43b4361b1abac8f7bcf9ad61051b40611273cb3a1759d483bb64ade1d4cfb8478036e2a3a693f006b730ddfd9c39905412ac76a1ee549e68af97babf5ef51f29f9a1c0ccf1859c1d6e02849713254351726a38ce58a9bd8e196b4e02742aef0f313306c8bb510686b9d6e28c849de0a28b8e2ccac96d63f3407b9a611a62b2a80fdd538427dcc49d19949053b4d6c8b43eefee975ac56626a982ac50a41ddf413bc1c2efacf9514ec13c3d30a4ca20c591e99c18ed805466f9e7ed68778533eb5e63cae38a3280003b69683ff9a40aa48a2ff0f412be352cd78f1a7d132fd7580d469dbfc43357ac77880b951c93aafef1692dd34f611de3d2a3df423210b909831f6f83ce912131c3372a430db5df6b3535f3969e0cc98c8795629b87e7150b04dce07000c75b6ea967deebba629966e53a2df8b702b218676304331ae5a6e928c70b17321ec1da77c0380560e23d27adeb56843f2db33d0b3f6f19675cdf2c218ce14f64c254ac21a49c6e3c927f19c54bb511345873a4b0bcf9f67cb39642faa62ba0987e1f42cf8468b910fa1af8b179dca3d57778177cf29bd1420b0908db712f1a2dfa9b1ce10be846dbfe9cc0482ce382ed15625c456bd70ace88f912ab68d111be578e454ea69a7cd3824908de05052c0a4fac4b2a4646280072ee9d936ad79d32884d972b5bd84142435e0c64ca422eeb8731ae61e7efd440ff406214f72d7a884bcb4f2a831255ddb7a5a169088b4db2e8dc21535b0be2820ea1b3cd330417a40e6ee7fce5e2e19462a8a3f1aabb2f1ebc51eb6eb9e71c009be0ff370e9276282fbee0823ff38fd76f54726c98af774ca955565ce4210874f9ea82a4a8f8533462da628c291476485cb4125ce0c5b3665cd2b8011c779332649190bc4a69ba1c318cd831a0f4930807795539bb6a81f8975ad8bf848e15b3e21feaf820001c8f4ad573a923b99c3da4bde6de2968e055ec3b4707ad524a53180fbeb84c764a40483a0677714bef1597c5ec798ae7d6d3b342f04dc57ead53a692ec3da847617a38a4bc5002769dfde62ec5f81ec7b3a806a7b1ba5224dc5ba41c239453d647f991c93b81aa176671704b5e80c5f68609a2cdda67f6e16d7321b343103cf3f2a30162c5181481ea192b9d9b48c04138b2360df56bd9517953a834f166c1765c7a034bd6fa39f49fd4203598dcdff6997c7119420aef6f33d204996b01500fac848cf3d4f27df9b8dc73f2524d51787d28c27b4882c20dc660f2c59381e4f66ec520544cc35c7ea11cf7b2a7cb90ccdbecc570075676b5cc771e88b8168dadb96003b4fb2521636009464ee4a15a5587d0fe0daa4a961fbe77184cca82fc0a9f29076d07150edc90c2375dc229c7b45dc4135657b86260540bd9cd07ad5b86f04e0ec311dc22aaa80a2960fe15e0e8dc42b2450e74a3fa43cbd462ef533995706c2684c414d3628f8e668fe6d9de25be45fac4488364f1019af8c6b3c624bdce9e60940c36edf2f4f43daf24527638b8647d56c5cf1de20c3a48116d35a3c183fc8af801d667c744d165466e6b689eca93c1a81dafd792c4d99022fb7c102d2515831918cf91ddc2085ad1d3de79a47dc0599d485ce28b70404217c1ddae7c5ed44dc4f2db0bd8df830fe5fc68466ded9c34a2a16b1e05318a8ee69ea051a6aca097aa6cb5dca8966ecb7ebb4d6364306c8fac58db5902a87033e45799207c3a2f04275ec4234c5b6e25b45caff5e39811d9c06d6f5d230c4cafc4063ba78f4876cecf4ff09aeb24c00680939658a10442289ada13e246297620f128c1f5f8eb89f3c37c401c6d11f6c2da1601900457ce389087c19b523a9dbbd30dc17e2d91098387b6a7140b5586a2d7eceb02f61ef4fb74ee7003e088d876ec8086991bfedacc02146fafb74724f8a6cbab8b9cca65e72061df0cd60aae27cfcb5213880078fa78c62d46580d8d3e61a527451baa98e66d1edaa315078cfb5150afc803513a82c0073b0a3f66a3c9ab7dc14b2da2dffb213e5e5bb2be3dd92bd18fcc8a8da927df76ef2506caa9af1f177dae51fb296fdd82a2268c1ff7c96971b56fd9d4f5bc82c22f0cce67333b7d0bb53ae52699ab89e754a7768f6841712fb6ddb6f301548a383b1f27aa228e457af566f39cb30910b9ac4242941e6e0ee187c069822a1a6b07937986fa24ed81611e2778809aee60103413629907c3533d745da36993c583908203614041c8476b407a92f348bb3298f11f63c23eddf0928de5d53f2796eac0624c82a76a09bb4a6b163b441027c0fd317238cc4a5acb13a4ebb4c108388c7f7af0e2d30fbc2e1d8329de42b0f3d9bd00ff75a93247bba510c2b9c346344127f5adabffca1f87899e5e47efa179cf8265b135dc3e9a48f11a3c6d469012ea9aa1148dfa7588aeee841b2260939752ae990f1b7b3ef48a5ede21aff9166424e93357878923c806079f05c2e5589c15c7ab6a99fedc0d161526b6a569f620f1f427b9244a6a46418018d03fafe02b1b62d4f6814e957496e2383285badf67d01fb87d507150fee6319f164d576dc39380b9251eb47fe56887dbf2fb1c37e7d11e2f442374ad2e632f1899862328da94577096a4667759c54064d526ed21ae07183b942584d0c9b8e6e40ba7d9333451a402b99378aa89ab814c52af20aecaa18c886c7655bfac3959f7d01484a4d4669d2ba2df3792255f8435348a89cc367328997d1a16aeaf6759648e7e1cd4cd4ca9cfa7824da04bde387af86e90b06bf80dacdc28a8ed0931e8ec41b03914a609b11b4ce7b5067474d4a9fe2b7d8fbcda3d9f941494a5b4790b4b8929157ebb830eb23f74d733c9bdd7391f185e2acd4f6f6aad54f27e67aa0";
    parse_hex_string(pk_str, pk, CRYPTO_PUBLICKEYBYTES);
    parse_hex_string(sk_str, sk, CRYPTO_SECRETKEYBYTES);
    parse_hex_string(m_str, m, mlen);
    // parse_hex_string(sm_str, sm, smlen);
    /////////////////////////////////////////////

    printf("\nRunning %d keypair+sign+open with MLEN=%lld\n", NUM_TESTS, mlen);

    int failures = 0;

    for(int i=0; i<NUM_TESTS; i++) {

        //////////////////////////
        initialize_csprng(&platform_csprng_state, entropy_input, 48);
        //////////////////////////

        // printf("\n\n ---> SIGN \n\n");
        if ( crypto_sign(sm, &smlen, m, mlen, sk) != 0) {
            printf("\n\n **** SIGN ERROR ****\n\n");
            exit(-1);
        }

        /////////////////////////////////////////////
        // parse_hex_string(sm_str, sm, smlen);
        /////////////////////////////////////////////

        // printf("\n\n ---> OPEN \n\n");
        if ( crypto_sign_open(m1, &mlen1, sm, smlen, pk) != 0) {
            printf("\n\n **** VERIFY ERROR ****\n\n");
            //////////////////////////////
            printf("\n");
            print_array_full("pk\t", pk, CRYPTO_PUBLICKEYBYTES);
            print_array_full("sk\t", sk, CRYPTO_SECRETKEYBYTES);
            print_array_full("m\t", m, mlen);
            print_array_full("m1\t", m1, mlen1);
            print_array_full("sm\t", sm, smlen);
            //////////////////////////////
            exit(-1);
            failures++;
        }
        if((i%PROGRESS == 0) && i) {
            printf(".");
            fflush(stdout);
        }
        if((i%PRINTARRAY == 0) && i) {
            printf("\n");
            print_array("pk\t", pk, CRYPTO_PUBLICKEYBYTES);
            print_array("sk\t", sk, CRYPTO_SECRETKEYBYTES);
            print_array("m\t", m, mlen);
            print_array("m1\t", m1, mlen1);
            print_array("sm\t", sm, smlen);
            fflush(stdout);
        }
        
    }
    // printf("\n\n ---> END \n\n");
    if(failures) printf("\nFailure rate: %f\n", (float)failures/(float)NUM_TESTS);
    printf("\n");

    free(m);
    free(m1);
    free(sm);
    free(sig);

}
